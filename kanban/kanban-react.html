<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swarm Kanban Monitor</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                    animation: {
                        'shimmer': 'shimmer 2s linear infinite',
                        'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                },
            },
        }
    </script>
    <style>
        :root {
            --background: 222.2 84% 4.9%;
            --foreground: 210 40% 98%;
            --card: 222.2 84% 4.9%;
            --card-foreground: 210 40% 98%;
            --popover: 222.2 84% 4.9%;
            --popover-foreground: 210 40% 98%;
            --primary: 217.2 91.2% 59.8%;
            --primary-foreground: 222.2 47.4% 11.2%;
            --secondary: 217.2 32.6% 17.5%;
            --secondary-foreground: 210 40% 98%;
            --muted: 217.2 32.6% 17.5%;
            --muted-foreground: 215 20.2% 65.1%;
            --accent: 217.2 32.6% 17.5%;
            --accent-foreground: 210 40% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 40% 98%;
            --border: 217.2 32.6% 17.5%;
            --input: 217.2 32.6% 17.5%;
            --ring: 224.3 76.3% 48%;
            --radius: 0.5rem;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .animate-shimmer {
            animation: shimmer 2s linear infinite;
        }
        
        /* Custom scrollbar */
        .scrollbar-thin {
            scrollbar-width: thin;
        }
        
        .scrollbar-thin::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        .scrollbar-thin::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background-color: rgba(155, 155, 155, 0.5);
            border-radius: 20px;
        }
    </style>
</head>
<body class="dark bg-background text-foreground">
    <div id="root"></div>
    
    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef, useMemo } = React;
        const socket = io();
        
        // UI Components
        const Card = ({ className = '', children, ...props }) => (
            <div className={`rounded-lg border bg-card text-card-foreground shadow-sm ${className}`} {...props}>
                {children}
            </div>
        );
        
        const CardHeader = ({ className = '', children, ...props }) => (
            <div className={`flex flex-col space-y-1.5 p-6 ${className}`} {...props}>
                {children}
            </div>
        );
        
        const CardContent = ({ className = '', children, ...props }) => (
            <div className={`p-6 pt-0 ${className}`} {...props}>
                {children}
            </div>
        );
        
        const Badge = ({ className = '', variant = 'default', children, ...props }) => {
            const variants = {
                default: 'bg-primary text-primary-foreground',
                secondary: 'bg-secondary text-secondary-foreground',
                destructive: 'bg-destructive text-destructive-foreground',
                outline: 'text-foreground border',
            };
            
            return (
                <div className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 ${variants[variant]} ${className}`} {...props}>
                    {children}
                </div>
            );
        };
        
        const Progress = ({ value = 0, className = '', ...props }) => (
            <div className={`relative h-4 w-full overflow-hidden rounded-full bg-secondary ${className}`} {...props}>
                <div 
                    className="h-full w-full flex-1 bg-primary transition-all duration-300 ease-in-out"
                    style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
                />
            </div>
        );
        
        const Select = ({ value, onValueChange, children, ...props }) => {
            return (
                <select 
                    value={value} 
                    onChange={(e) => onValueChange(e.target.value)}
                    className="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                    {...props}
                >
                    {children}
                </select>
            );
        };
        
        // Icons
        const Wifi = ({ className = '' }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 12.55a11 11 0 0 1 14.08 0" />
                <path d="M1.42 9a16 16 0 0 1 21.16 0" />
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
                <line x1="12" y1="20" x2="12.01" y2="20" />
            </svg>
        );
        
        const WifiOff = ({ className = '' }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="1" y1="1" x2="23" y2="23" />
                <path d="M16.72 11.06A10.94 10.94 0 0 1 19 12.55" />
                <path d="M5 12.55a10.94 10.94 0 0 1 5.17-2.39" />
                <path d="M10.71 5.05A16 16 0 0 1 22.58 9" />
                <path d="M1.42 9a15.91 15.91 0 0 1 4.7-2.88" />
                <path d="M8.53 16.11a6 6 0 0 1 6.95 0" />
                <line x1="12" y1="20" x2="12.01" y2="20" />
            </svg>
        );
        
        const RefreshCw = ({ className = '' }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="23 4 23 10 17 10" />
                <polyline points="1 20 1 14 7 14" />
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
            </svg>
        );
        
        const Terminal = ({ className = '' }) => (
            <svg className={className} width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="4 17 10 11 4 5" />
                <line x1="12" y1="19" x2="20" y2="19" />
            </svg>
        );
        
        const Play = ({ className = '' }) => (
            <svg className={className} width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5 3 19 12 5 21 5 3" />
            </svg>
        );
        
        const Pause = ({ className = '' }) => (
            <svg className={className} width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="4" width="4" height="16" />
                <rect x="14" y="4" width="4" height="16" />
            </svg>
        );
        
        const AlertTriangle = ({ className = '' }) => (
            <svg className={className} width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
            </svg>
        );
        
        // Components
        const WebSocketIndicator = ({ isConnected }) => (
            <div className="fixed top-4 right-4 z-50">
                <div className={`flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium ${
                    isConnected 
                        ? 'bg-green-500/10 text-green-500 border border-green-500/20' 
                        : 'bg-destructive/10 text-destructive border border-destructive/20'
                }`}>
                    <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500' : 'bg-destructive'} ${isConnected ? 'animate-pulse' : ''}`} />
                    {isConnected ? 'Connected' : 'Disconnected'}
                </div>
            </div>
        );
        
        const TaskItem = ({ task, status }) => {
            const statusStyles = {
                'completed': 'border-l-green-500 bg-green-500/5 text-muted-foreground line-through',
                'in-progress': 'border-l-orange-500 bg-orange-500/5',
                'pending': 'border-l-gray-400 bg-gray-400/5',
            };
            
            return (
                <div className={`p-2 text-xs border-l-2 rounded-sm transition-all hover:bg-muted/50 ${statusStyles[status]}`}>
                    {task}
                </div>
            );
        };
        
        const TerminalColumn = ({ terminal }) => {
            const getStatusIcon = () => {
                switch (terminal.status) {
                    case 'active':
                    case 'WORKING':
                        return <Play className="text-green-500" />;
                    case 'idle':
                    case 'NOT_STARTED':
                        return <Pause className="text-yellow-500" />;
                    case 'error':
                    case 'ERROR':
                        return <AlertTriangle className="text-destructive" />;
                    case 'COMPLETED':
                        return <Play className="text-blue-500" />;
                    default:
                        return null;
                }
            };
            
            const getStatusColor = () => {
                switch (terminal.status) {
                    case 'active':
                    case 'WORKING':
                        return 'bg-green-100 text-green-800 border-green-200 dark:bg-green-900/20 dark:text-green-400 dark:border-green-800';
                    case 'idle':
                    case 'NOT_STARTED':
                        return 'bg-yellow-100 text-yellow-800 border-yellow-200 dark:bg-yellow-900/20 dark:text-yellow-400 dark:border-yellow-800';
                    case 'error':
                    case 'ERROR':
                        return 'bg-red-100 text-red-800 border-red-200 dark:bg-red-900/20 dark:text-red-400 dark:border-red-800';
                    case 'COMPLETED':
                        return 'bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-900/20 dark:text-blue-400 dark:border-blue-800';
                    default:
                        return 'bg-gray-100 text-gray-800 border-gray-200 dark:bg-gray-900/20 dark:text-gray-400 dark:border-gray-800';
                }
            };
            
            const getCardBorderColor = () => {
                switch (terminal.status) {
                    case 'active':
                    case 'WORKING':
                        return 'border-green-200 dark:border-green-800';
                    case 'COMPLETED':
                        return 'border-blue-200 dark:border-blue-800';
                    case 'idle':
                    case 'NOT_STARTED':
                        return '';
                    case 'error':
                    case 'ERROR':
                        return 'border-red-200 dark:border-red-800';
                    default:
                        return '';
                }
            };
            
            return (
                <Card className={`h-fit transition-all duration-300 hover:shadow-lg ${getCardBorderColor()}`}>
                    <CardHeader className="pb-3">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <Terminal className="h-4 w-4" />
                                <h3 className="font-medium">Terminal {terminal.id}</h3>
                            </div>
                            <div className="flex items-center gap-1">
                                {getStatusIcon()}
                                <Badge className={`text-xs ${getStatusColor()}`}>
                                    {terminal.status}
                                </Badge>
                            </div>
                        </div>
                        
                        <div className="space-y-2">
                            <div className="text-sm text-muted-foreground">
                                Current Task:
                            </div>
                            <p className="text-sm font-medium leading-tight">
                                {terminal.currentTask}
                            </p>
                            
                            <div className="space-y-1">
                                <div className="flex justify-between items-center">
                                    <span className="text-xs text-muted-foreground">Progress</span>
                                    <span className="text-xs text-muted-foreground">
                                        {terminal.progress}%
                                    </span>
                                </div>
                                <div className="relative">
                                    <Progress value={terminal.progress} className="h-1.5" />
                                    {(terminal.status === 'active' || terminal.status === 'WORKING') && (
                                        <div
                                            className="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent h-1.5 rounded-full animate-shimmer"
                                            style={{ width: '20%' }}
                                        />
                                    )}
                                </div>
                            </div>
                        </div>
                    </CardHeader>
                    
                    <CardContent className="space-y-3">
                        {terminal.completedTasks.length > 0 && (
                            <div className="space-y-2">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-green-500" />
                                    <h4 className="text-sm font-medium">Completed ({terminal.completedTasks.length})</h4>
                                </div>
                                <div className="space-y-1 max-h-48 overflow-y-auto scrollbar-thin">
                                    {terminal.completedTasks.slice(0, 3).map((task, index) => (
                                        <TaskItem key={`${task}-${index}`} task={task} status="completed" />
                                    ))}
                                    {terminal.completedTasks.length > 3 && (
                                        <div className="text-xs text-muted-foreground text-center py-1">
                                            +{terminal.completedTasks.length - 3} more
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {terminal.inProgressTasks.length > 0 && (
                            <div className="space-y-2">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-orange-500" />
                                    <h4 className="text-sm font-medium">In Progress ({terminal.inProgressTasks.length})</h4>
                                </div>
                                <div className="space-y-1 max-h-48 overflow-y-auto scrollbar-thin">
                                    {terminal.inProgressTasks.slice(0, 2).map((task, index) => (
                                        <TaskItem key={`${task}-${index}`} task={task} status="in-progress" />
                                    ))}
                                    {terminal.inProgressTasks.length > 2 && (
                                        <div className="text-xs text-muted-foreground text-center py-1">
                                            +{terminal.inProgressTasks.length - 2} more
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {terminal.pendingTasks.length > 0 && (
                            <div className="space-y-2">
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-gray-400" />
                                    <h4 className="text-sm font-medium">Pending ({terminal.pendingTasks.length})</h4>
                                </div>
                                <div className="space-y-1 max-h-48 overflow-y-auto scrollbar-thin">
                                    {terminal.pendingTasks.slice(0, 3).map((task, index) => (
                                        <TaskItem key={`${task}-${index}`} task={task} status="pending" />
                                    ))}
                                    {terminal.pendingTasks.length > 3 && (
                                        <div className="text-xs text-muted-foreground text-center py-1">
                                            +{terminal.pendingTasks.length - 3} more
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {terminal.completedTasks.length === 0 && 
                         terminal.inProgressTasks.length === 0 && 
                         terminal.pendingTasks.length === 0 && (
                            <div className="text-center py-8 text-muted-foreground">
                                <Terminal className="h-8 w-8 mx-auto mb-2 opacity-50" />
                                <p className="text-sm">No tasks assigned</p>
                            </div>
                        )}
                    </CardContent>
                </Card>
            );
        };
        
        const KanbanBoard = () => {
            const [selectedProject, setSelectedProject] = useState('');
            const [isConnected, setIsConnected] = useState(false);
            const [lastUpdate, setLastUpdate] = useState(new Date().toLocaleTimeString());
            const [isRefreshing, setIsRefreshing] = useState(false);
            const [projects, setProjects] = useState([]);
            const [currentProject, setCurrentProject] = useState(null);
            const [terminals, setTerminals] = useState([]);
            const [overallProgress, setOverallProgress] = useState(0);
            const [phase, setPhase] = useState({ current: 0, name: 'Unknown' });
            
            useEffect(() => {
                // Load projects on mount
                loadProjects();
                
                // Socket listeners
                socket.on('connect', () => {
                    setIsConnected(true);
                });
                
                socket.on('disconnect', () => {
                    setIsConnected(false);
                });
                
                socket.on('status_update', (data) => {
                    if (!data.error) {
                        updateFromServerData(data);
                    }
                });
                
                return () => {
                    socket.off('connect');
                    socket.off('disconnect');
                    socket.off('status_update');
                };
            }, []);
            
            const loadProjects = async () => {
                try {
                    const response = await fetch('/api/projects');
                    const data = await response.json();
                    setProjects(data);
                    
                    if (data.length === 1) {
                        setSelectedProject(data[0].name);
                        loadProject(data[0].name);
                    }
                } catch (error) {
                    console.error('Failed to load projects:', error);
                }
            };
            
            const loadProject = async (projectName) => {
                if (!projectName) return;
                
                try {
                    const response = await fetch(`/api/project/${projectName}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        socket.emit('request_update');
                    }
                } catch (error) {
                    console.error('Failed to load project:', error);
                }
            };
            
            const updateFromServerData = (data) => {
                setLastUpdate(new Date().toLocaleTimeString());
                
                // Update phase
                if (data.phase) {
                    setPhase({
                        current: data.phase.current || 1,
                        name: data.phase.name || 'Unknown'
                    });
                }
                
                // Update overall progress
                setOverallProgress(data.overall_progress || 0);
                
                // Transform terminal data
                const terminalData = [];
                for (let i = 1; i <= 5; i++) {
                    const terminal = data.terminals?.[i.toString()] || {};
                    const tasks = terminal.tasks || {};
                    
                    terminalData.push({
                        id: i,
                        status: terminal.status || 'idle',
                        currentTask: terminal.task || 'No task assigned',
                        progress: terminal.progress || 0,
                        completedTasks: (tasks.completed || []).map(t => typeof t === 'string' ? t : t.text),
                        inProgressTasks: (tasks.in_progress || []).map(t => typeof t === 'string' ? t : t.text),
                        pendingTasks: (tasks.pending || []).map(t => typeof t === 'string' ? t : t.text)
                    });
                }
                setTerminals(terminalData);
                
                // Check phase completion
                checkPhaseCompletion(terminalData);
            };
            
            const checkPhaseCompletion = (terminalData) => {
                const allCompleted = terminalData.every(t => 
                    t.status === 'COMPLETED' || 
                    t.progress >= 100 ||
                    (t.completedTasks.length > 0 && t.pendingTasks.length === 0 && t.inProgressTasks.length === 0)
                );
                
                if (allCompleted) {
                    console.log('All terminals completed for phase', phase.current);
                }
            };
            
            const handleRefresh = () => {
                setIsRefreshing(true);
                socket.emit('request_update');
                setTimeout(() => {
                    setIsRefreshing(false);
                }, 1000);
            };
            
            const getPhaseColor = (phaseName) => {
                const colors = {
                    'Foundation': 'bg-blue-500',
                    'Core Development': 'bg-orange-500',
                    'Advanced Features': 'bg-purple-500',
                    'Polish & Deploy': 'bg-green-500'
                };
                return colors[phaseName] || 'bg-gray-500';
            };
            
            return (
                <div className="min-h-screen bg-background p-4 space-y-6">
                    <WebSocketIndicator isConnected={isConnected} />
                    
                    <Card>
                        <CardHeader className="pb-4">
                            <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                                <div className="flex items-center gap-4">
                                    <div className="space-y-1">
                                        <h1 className="text-2xl font-semibold">
                                            Swarm Kanban Monitor
                                        </h1>
                                        <p className="text-muted-foreground">
                                            Real-time monitoring for Swarm AI agents
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2">
                                        {isConnected ? (
                                            <Wifi className="h-4 w-4 text-green-500" />
                                        ) : (
                                            <WifiOff className="h-4 w-4 text-destructive" />
                                        )}
                                        <span className="text-sm text-muted-foreground">
                                            {isConnected ? 'Connected' : 'Disconnected'}
                                        </span>
                                    </div>
                                    
                                    <button
                                        onClick={handleRefresh}
                                        disabled={isRefreshing}
                                        className="flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground transition-colors disabled:opacity-50"
                                    >
                                        <RefreshCw className={`h-4 w-4 ${isRefreshing ? 'animate-spin' : ''}`} />
                                        Refresh
                                    </button>
                                </div>
                            </div>
                        </CardHeader>
                        
                        <CardContent className="space-y-4">
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                <div className="space-y-2">
                                    <label className="text-sm font-medium">Project</label>
                                    <Select value={selectedProject} onValueChange={(value) => {
                                        setSelectedProject(value);
                                        loadProject(value);
                                    }}>
                                        <option value="">Select project...</option>
                                        {projects.map(project => (
                                            <option key={project.name} value={project.name}>
                                                {project.name}
                                            </option>
                                        ))}
                                    </Select>
                                </div>
                                
                                <div className="space-y-2">
                                    <label className="text-sm font-medium">Current Phase</label>
                                    <div className="flex items-center gap-2">
                                        <div className={`w-2 h-2 rounded-full ${getPhaseColor(phase.name)}`} />
                                        <Badge variant="outline">Phase {phase.current}: {phase.name}</Badge>
                                    </div>
                                </div>
                                
                                <div className="space-y-2">
                                    <label className="text-sm font-medium">Last Update</label>
                                    <p className="text-sm text-muted-foreground">
                                        {lastUpdate}
                                    </p>
                                </div>
                            </div>
                            
                            <div className="space-y-2">
                                <div className="flex justify-between items-center">
                                    <label className="text-sm font-medium">Overall Progress</label>
                                    <span className="text-sm text-muted-foreground">
                                        {overallProgress}%
                                    </span>
                                </div>
                                <div className="relative">
                                    <Progress value={overallProgress} className="h-2" />
                                    <div
                                        className="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent h-2 rounded-full animate-shimmer"
                                        style={{ width: '30%' }}
                                    />
                                </div>
                            </div>
                        </CardContent>
                    </Card>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-5 gap-4">
                        {terminals.map((terminal) => (
                            <TerminalColumn key={terminal.id} terminal={terminal} />
                        ))}
                    </div>
                </div>
            );
        };
        
        // Render the app
        ReactDOM.render(<KanbanBoard />, document.getElementById('root'));
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>